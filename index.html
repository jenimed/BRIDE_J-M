<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Confirmar Asistencia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --maxw: 980px; }
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .container { display: flex; min-height: 100vh; }
    .imagen { flex: 1; background-image: url('j%26M-54%20(1).jpg'); background-size: cover; background-position: center; }
    .contenido { flex: 1; padding: 48px; display: flex; flex-direction: column; justify-content: center; text-align: center; background-color: #f7f7f7; }
    h1 { margin-bottom: 10px; }
    p { margin: 5px 0 16px; }
    input, button, select {
      padding: 12px; font-size: 16px; margin: 10px auto; border-radius: 20px;
      border: 1px solid #ccc; width: 70%; max-width: var(--maxw); display: block;
    }
    .muted { color:#666; font-weight: normal; }
    .error { color: #b00020; font-weight: normal; }
    button { cursor: pointer; background-color: #333; color: white; border: none; }
    button:hover { background-color: #555; }
    .grid { width: 90%; max-width: var(--maxw); margin: 0 auto; text-align: left; }
    .grid .row { display: grid; grid-template-columns: 2.2fr 1fr 1.6fr 1.1fr; gap: 10px; align-items: center; margin: 8px 0; }
    .controls { display: flex; gap: 10px; justify-content: center; margin-top: 8px; flex-wrap: wrap; }
    .controls button { width: auto; display: inline-block; padding: 12px 18px; }
    @media (max-width: 900px) {
      .container { flex-direction: column; }
      .imagen { min-height: 36vh; }
      .contenido { padding: 28px; }
      input, button, select { width: 100%; }
      .grid { max-width: 100%; }
      .grid .row { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 480px) {
      .contenido { padding: 22px; }
      body { font-size: 15px; }
      .grid .row { grid-template-columns: 1fr; }
      .grid .row > * { margin-bottom: 2px; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="imagen" aria-hidden="true"></div>
  <div class="contenido">
    <h1 id="titulo">CONFIRMAR ASISTENCIA</h1>

    <!-- Paso 1 -->
    <div id="step1">
      <p>Por favor ingresa tu c√≥digo de invitado.</p>
      <input type="text" id="codigo" placeholder="Ingresa tu c√≥digo de invitado" autocomplete="one-time-code" />
      <button id="btnContinuar">Continuar</button>
      <div id="msg1" class="error"></div>
    </div>

    <!-- Paso 2 -->
    <div id="step2" style="display:none;">
      <div id="encabezado"></div>
      <div id="detalles" class="grid"></div>

      <!-- Comentario (texto plano, tomado de Invitados!E) -->
      <p class="muted" style="width:90%;max-width:var(--maxw);margin:8px auto 0;text-align:left;">
        <strong>Comentario:</strong> <span id="comentarioAbajo">(sin comentario)</span>
      </p>

      <div class="controls">
        <button id="btnGuardar">Aceptar</button>
        <button id="btnReiniciarTodos">Reiniciar a pendiente</button>
        <button id="btnSalir">Salir</button>
      </div>
    </div>
  </div>
</div>

<script>
/* üëâ Usa tu nueva URL del Web App */
const apiUrl = "https://script.google.com/macros/s/AKfycbzKwd749J3Hdgx8KThyONj6mBuPJAdXUlYnBB7A9LC_eb1ePWKRp-S2HHca8_6jkxfgTg/exec";

const $ = s => document.querySelector(s);
const step1 = $("#step1"), step2 = $("#step2");
const inputCodigo = $("#codigo"), btnContinuar = $("#btnContinuar"), msg1 = $("#msg1");
const titleEl = $("#titulo"), encabezado = $("#encabezado"), detallesEl = $("#detalles");
const btnGuardar = $("#btnGuardar"), btnReiniciarTodos = $("#btnReiniciarTodos"), btnSalir = $("#btnSalir");
const comentarioEl = $("#comentarioAbajo");

const MENSAJE = "Estamos muy felices de poder compartir contigo este momento tan especial. Tu presencia har√° a√∫n m√°s inolvidable nuestra celebraci√≥n.";
let CURRENT = { codigo:"", nombre:"", pases:0, estado:"", comentario:"", detalles:[] };

function nocache(u){ return u + (u.includes("?") ? "&" : "?") + "_ts=" + Date.now(); }
function setLoading(btn, on, txt){ if(!btn) return; if(on){btn.dataset.prevText=btn.textContent;btn.textContent=txt||"Cargando...";btn.disabled=true;}else{btn.textContent=btn.dataset.prevText||btn.textContent;btn.disabled=false;} }

/* Parser robusto por si Apps Script responde JSON ‚Äúentrecomillado‚Äù */
function parseAppsScript(text){
  try { return JSON.parse(text); }
  catch (_) { return JSON.parse(JSON.parse(text)); }
}

/* Pinta encabezado con mensaje, pases y estado general */
function renderEncabezado() {
  encabezado.innerHTML =
    `<p class="muted" style="max-width:70%;margin:0 auto 16px;">${MENSAJE}</p>
     <p><strong>No. de pases:</strong> ${CURRENT.pases}</p>
     <p><strong>Estado general:</strong> ${CURRENT.estado || "Pendiente"}</p>`;
}
function labelFromValue(v){ v=(v||"Pendiente").toLowerCase(); if(v==="confirmado")return"Confirmar"; if(v==="rechazado")return"No asistir√©"; return"Pendiente"; }
function valueFromLabel(l){ if(l==="Confirmar")return"Confirmado"; if(l==="No asistir√©")return"Rechazado"; return"Pendiente"; }

/* Lista por persona (detalle) con selecci√≥n de Asistencia y Estado */
function renderDetalles() {
  detallesEl.innerHTML = "";
  const head = document.createElement("div");
  head.className = "row";
  head.innerHTML = `<strong>Nombre</strong><strong>Estado</strong><strong>Asistencia</strong><strong>Acci√≥n</strong>`;
  detallesEl.appendChild(head);

  CURRENT.detalles.forEach(d=>{
    const row=document.createElement("div"); row.className="row";
    const c1=document.createElement("div"); c1.textContent=d.nombre||("Invitado "+d.idx);
    const c2=document.createElement("div"); c2.textContent=d.estado||"Pendiente";

    const c3=document.createElement("div");
    const sTipo=document.createElement("select");
    ["Ceremonia","Cena","Ambas"].forEach(lbl=>{
      const o=document.createElement("option"); o.value=lbl; o.textContent=lbl;
      if((d.tipo||"Ambas")===lbl) o.selected=true; sTipo.appendChild(o);
    });
    sTipo.dataset.idx=d.idx; sTipo.dataset.kind="tipo"; c3.appendChild(sTipo);

    const c4=document.createElement("div");
    const sEst=document.createElement("select");
    ["Confirmar","No asistir√©","Pendiente"].forEach(lbl=>{
      const o=document.createElement("option"); o.value=lbl; o.textContent=lbl;
      if(lbl===labelFromValue(d.estado)) o.selected=true; sEst.appendChild(o);
    });
    sEst.dataset.idx=d.idx; sEst.dataset.kind="estado"; c4.appendChild(sEst);

    row.appendChild(c1); row.appendChild(c2); row.appendChild(c3); row.appendChild(c4);
    detallesEl.appendChild(row);
  });
}

/* Carga datos por c√≥digo y PINTA nombre + comentario de inmediato */
async function cargarInvitado(codigo){
  const res = await fetch(nocache(`${apiUrl}?codigo=${encodeURIComponent(codigo)}`), { cache:"no-store" });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const text = await res.text();
  const data = parseAppsScript(text);

  // Imprimir nombre y comentario DIRECTO, sin esperar a nada m√°s
  titleEl.textContent = data.nombre || "Invitado";
  comentarioEl.textContent = (data.comentario || "").toString().trim() || "(sin comentario)";

  // Guardar para el resto de la UI
  CURRENT = {
    codigo,
    nombre: data.nombre,
    pases: data.pases,
    estado: data.estado || "Pendiente",
    comentario: data.comentario || "",
    detalles: data.detalles || []
  };
}

/* Flujo */
btnContinuar.addEventListener("click", async ()=>{
  const codigo = inputCodigo.value.trim();
  if(!codigo){ msg1.textContent="Por favor ingresa tu c√≥digo."; inputCodigo.focus(); return; }
  msg1.textContent=""; setLoading(btnContinuar,true,"Buscando...");
  try{
    await cargarInvitado(codigo);
    step1.style.display="none"; step2.style.display="block";
    renderEncabezado(); renderDetalles();
  }catch(e){ msg1.textContent=e.message||"No se pudo encontrar el invitado."; }
  finally{ setLoading(btnContinuar,false); }
});
inputCodigo.addEventListener("keydown", e=>{ if(e.key==="Enter") btnContinuar.click(); });

btnGuardar.addEventListener("click", async ()=>{
  setLoading(btnGuardar,true,"Guardando...");
  try{
    const estadoByIdx=new Map(CURRENT.detalles.map(d=>[String(d.idx),(d.estado||"Pendiente")]));
    const tipoByIdx=new Map(CURRENT.detalles.map(d=>[String(d.idx),(d.tipo||"Ambas")]));
    const cambios={};

    CURRENT.detalles.forEach(d=>{
      const idx=String(d.idx);
      const selEst=detallesEl.querySelector(`select[data-idx="${idx}"][data-kind="estado"]`);
      if(selEst){
        const nuevo=valueFromLabel(selEst.value);
        const actual=estadoByIdx.get(idx)||"Pendiente";
        if(nuevo!==actual){ if(!cambios[idx]) cambios[idx]={}; cambios[idx].estado=nuevo; }
      }
      const selTipo=detallesEl.querySelector(`select[data-idx="${idx}"][data-kind="tipo"]`);
      if(selTipo){
        const nuevo=selTipo.value||"Ambas";
        const actual=tipoByIdx.get(idx)||"Ambas";
        if(nuevo!==actual){ if(!cambios[idx]) cambios[idx]={}; cambios[idx].tipo=nuevo; }
      }
    });

    const idxs=Object.keys(cambios);
    for(const idx of idxs){
      const ch=cambios[idx];
      const url=nocache(`${apiUrl}?accion=actualizar_detalle&codigo=${encodeURIComponent(CURRENT.codigo)}&idx=${encodeURIComponent(idx)}${ch.estado?`&estado=${encodeURIComponent(ch.estado)}`:''}${ch.tipo?`&tipo=${encodeURIComponent(ch.tipo)}`:''}`);
      const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const t=await r.text(); const dj=parseAppsScript(t); if(!dj.success) throw new Error(dj.message||"No se pudo actualizar");
    }

    await cargarInvitado(CURRENT.codigo);
    renderEncabezado(); renderDetalles();
    // Vuelve a pintar comentario directo tras guardar
    comentarioEl.textContent = (CURRENT.comentario || "").toString().trim() || "(sin comentario)";
    alert("Actualizado.");
  }catch(e){ alert(e.message||"No se pudo guardar."); }
  finally{ setLoading(btnGuardar,false); }
});

btnReiniciarTodos.addEventListener("click", async ()=>{
  setLoading(btnReiniciarTodos,true,"Reiniciando...");
  try{
    const url=nocache(`${apiUrl}?accion=reiniciar_todos&codigo=${encodeURIComponent(CURRENT.codigo)}`);
    const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const t=await r.text(); const dj=parseAppsScript(t); if(!dj.success) throw new Error(dj.message||"No se pudo reiniciar");
    await cargarInvitado(CURRENT.codigo);
    renderEncabezado(); renderDetalles();
    comentarioEl.textContent = (CURRENT.comentario || "").toString().trim() || "(sin comentario)";
  }catch(e){ alert(e.message||"No se pudo reiniciar."); }
  finally{ setLoading(btnReiniciarTodos,false); }
});

btnSalir.addEventListener("click", ()=>{
  CURRENT={codigo:"",nombre:"",pases:0,estado:"",comentario:"",detalles:[]};
  encabezado.innerHTML=""; detallesEl.innerHTML="";
  step2.style.display="none"; step1.style.display="block";
  msg1.textContent=""; inputCodigo.value=""; titleEl.textContent="CONFIRMAR ASISTENCIA";
  comentarioEl.textContent="(sin comentario)"; inputCodigo.focus();
});
</script>
</body>
</html>
