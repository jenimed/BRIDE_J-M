<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Confirmar Asistencia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .container { display: flex; min-height: 100vh; }
    .imagen {
      flex: 1;
      background-image: url('j%26M-54%20(1).jpg'); /* ajusta si cambia el nombre */
      background-size: cover;
      background-position: center;
    }
    .contenido {
      flex: 1;
      padding: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: center;
      background-color: #f7f7f7;
    }
    h1 { margin-bottom: 10px; }
    p { margin: 5px 0 20px; }
    input, button, select, textarea {
      padding: 12px; font-size: 16px; margin: 10px auto; border-radius: 20px;
      border: 1px solid #ccc; width: 70%; max-width: 820px; display: block;
    }
    .muted { color:#666; font-weight: normal; }
    .error { color: #b00020; font-weight: normal; }
    button { cursor: pointer; background-color: #333; color: white; border: none; }
    button:hover { background-color: #555; }

    .grid { width: 90%; max-width: 820px; margin: 0 auto; text-align: left; }
    .grid .row { display: grid; grid-template-columns: 2.2fr 1.1fr 1fr; gap: 10px; align-items: center; margin: 8px 0; }
    .accionStack { display:flex; flex-direction: column; gap: 8px; }
    .controls {
      display: flex; gap: 10px; justify-content: center; margin-top: 8px; flex-wrap: nowrap;
    }
    .controls button { width: auto; display: inline-block; padding: 12px 18px; }

    @media (max-width: 900px) {
      .container { flex-direction: column; }
      .imagen { min-height: 40vh; }
      .contenido { padding: 32px; }
      input, button, select, textarea { width: 100%; }
      .grid .row { grid-template-columns: 1fr 1fr; }
      /* .controls { flex-wrap: wrap; }  // descomenta si prefieres envolver en móvil */
    }
  </style>
</head>
<body>
<div class="container">
  <div class="imagen" aria-hidden="true"></div>

  <div class="contenido">
    <!-- TÍTULO dinámico (se reemplaza por el nombre del invitado en el paso 2) -->
    <h1 id="titulo">CONFIRMAR ASISTENCIA</h1>

    <!-- Paso 1 -->
    <div id="step1">
      <p>Por favor ingresa tu código de invitado.</p>
      <input type="text" id="codigo" placeholder="Ingresa tu código de invitado" autocomplete="one-time-code" />
      <button id="btnContinuar">Continuar</button>
      <div id="msg1" class="error"></div>
    </div>

    <!-- Paso 2 -->
    <div id="step2" style="display:none;">
      <div id="encabezado"></div>

      <div id="detalles" class="grid"></div>

      <!-- Comentario por familia/código -->
      <textarea id="comentario" rows="3" placeholder="Comentario (opcional): alergias, restricciones, horario de llegada, etc."></textarea>

      <div class="controls">
        <button id="btnGuardar">Aceptar</button>
        <button id="btnReiniciarTodos">Reiniciar a pendiente</button>
        <button id="btnSalir">Salir</button>
      </div>
    </div>
  </div>
</div>

<script>
/* 🔗 Endpoint actual */
const apiUrl = "https://script.google.com/macros/s/AKfycbxYxCPNJnt8Fjvo1_f1RapU1KTH8D-tPs6OHkuTOkV-EV5tnFX3GeRrR9I3QpUXcqJ4vw/exec";

const $ = (s)=>document.querySelector(s);
const step1 = $("#step1");
const step2 = $("#step2");
const inputCodigo = $("#codigo");
const btnContinuar = $("#btnContinuar");
const msg1 = $("#msg1");
const titleEl = document.getElementById("titulo");
const encabezado = $("#encabezado");
const detallesEl = $("#detalles");
const txtComentario = $("#comentario");
const btnGuardar = $("#btnGuardar");
const btnReiniciarTodos = $("#btnReiniciarTodos");
const btnSalir = $("#btnSalir");

const MENSAJE = `Estamos muy felices de poder compartir contigo este momento tan especial.
Tu presencia hará aún más inolvidable nuestra celebración.`;

let CURRENT = { codigo: "", nombre: "", pases: 0, estado: "", comentario: "", detalles: [] };

function setLoading(btn, loading=true, text="Cargando..."){
  if (!btn) return;
  if (loading) { btn.dataset.prevText = btn.textContent; btn.textContent = text; btn.disabled = true; }
  else { btn.textContent = btn.dataset.prevText || btn.textContent; btn.disabled = false; }
}

function resetFlow(){
  CURRENT = { codigo: "", nombre: "", pases: 0, estado: "", comentario: "", detalles: [] };
  encabezado.innerHTML = "";
  detallesEl.innerHTML = "";
  step2.style.display = "none";
  step1.style.display = "block";
  msg1.textContent = "";
  inputCodigo.value = "";
  txtComentario.value = "";
  if (titleEl) titleEl.textContent = "CONFIRMAR ASISTENCIA";
  inputCodigo.focus();
}

function renderEncabezado() {
  const { pases, estado } = CURRENT;
  encabezado.innerHTML = `
    <p class="muted" style="max-width:70%;margin:0 auto 16px;">${MENSAJE}</p>
    <p><strong>No. de pases:</strong> ${pases}</p>
    <p><strong>Estado general:</strong> ${estado || "Pendiente"}</p>
  `;
}

function labelFromValue(v){
  v = (v || "Pendiente").toLowerCase();
  if (v === "confirmado") return "Confirmar";
  if (v === "rechazado") return "No asistiré";
  return "Pendiente";
}
function valueFromLabel(lbl){
  if (lbl === "Confirmar") return "Confirmado";
  if (lbl === "No asistiré") return "Rechazado";
  return "Pendiente";
}

function renderDetalles() {
  detallesEl.innerHTML = "";

  // Cabecera
  const head = document.createElement("div");
  head.className = "row";
  head.innerHTML = `<strong>Nombre</strong><strong>Estado</strong><strong>Acción</strong>`;
  detallesEl.appendChild(head);

  // Filas
  CURRENT.detalles.forEach(d => {
    const row = document.createElement("div");
    row.className = "row";

    // Nombre (solo lectura)
    const col1 = document.createElement("div");
    col1.textContent = d.nombre || ("Invitado " + d.idx);

    // Estado actual (texto)
    const col2 = document.createElement("div");
    col2.textContent = d.estado || "Pendiente";

    // Acción (dos selects: decisión y tipo de asistencia)
    const col3 = document.createElement("div");
    const stack = document.createElement("div");
    stack.className = "accionStack";

    // Select de decisión (estado)
    const selEstado = document.createElement("select");
    ["Confirmar","No asistiré","Pendiente"].forEach(lbl=>{
      const opt = document.createElement("option");
      opt.value = lbl; opt.textContent = lbl;
      if (lbl === labelFromValue(d.estado)) opt.selected = true;
      selEstado.appendChild(opt);
    });
    selEstado.dataset.idx = d.idx;
    selEstado.dataset.kind = "estado";
    stack.appendChild(selEstado);

    // Select de tipo (Ceremonia/Cena/Ambas)
    const selTipo = document.createElement("select");
    ["Ceremonia","Cena","Ambas"].forEach(lbl=>{
      const opt = document.createElement("option");
      opt.value = lbl; opt.textContent = lbl;
      if ((d.tipo || "Ambas") === lbl) opt.selected = true;
      selTipo.appendChild(opt);
    });
    selTipo.dataset.idx = d.idx;
    selTipo.dataset.kind = "tipo";
    stack.appendChild(selTipo);

    col3.appendChild(stack);

    row.appendChild(col1); row.appendChild(col2); row.appendChild(col3);
    detallesEl.appendChild(row);
  });

  // Comentario
  txtComentario.value = CURRENT.comentario || "";
}

async function cargarInvitado(codigo) {
  const url = `${apiUrl}?codigo=${encodeURIComponent(codigo)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();
  if (data.error) throw new Error(data.error);

  CURRENT = {
    codigo,
    nombre: data.nombre,
    pases: data.pases,
    estado: data.estado || "Pendiente",
    comentario: data.comentario || "",
    detalles: data.detalles || []  // [{idx,nombre,estado,tipo}]
  };

  // Título = nombre principal en grande
  if (titleEl) titleEl.textContent = CURRENT.nombre || "Invitado";
}

btnContinuar.addEventListener("click", async ()=>{
  const codigo = inputCodigo.value.trim();
  if (!codigo) { msg1.textContent = "Por favor ingresa tu código."; inputCodigo.focus(); return; }

  msg1.textContent = "";
  setLoading(btnContinuar, true, "Buscando...");
  try {
    await cargarInvitado(codigo);
    step1.style.display = "none";
    step2.style.display = "block";
    renderEncabezado();
    renderDetalles();
  } catch (err) {
    console.error(err);
    msg1.textContent = err.message || "No se pudo encontrar el invitado.";
  } finally {
    setLoading(btnContinuar, false);
  }
});

inputCodigo.addEventListener("keydown", (e)=>{ if (e.key === "Enter") btnContinuar.click(); });

btnGuardar.addEventListener("click", async ()=>{
  const selects = detallesEl.querySelectorAll("select");
  setLoading(btnGuardar, true, "Guardando...");
  try {
    // Mapas actuales
    const estadoByIdx = new Map(CURRENT.detalles.map(d => [String(d.idx), (d.estado || "Pendiente")]));
    const tipoByIdx   = new Map(CURRENT.detalles.map(d => [String(d.idx), (d.tipo   || "Ambas")]));

    // Agrupar cambios por idx
    const cambios = {}; // { idx: {estado?, tipo?} }
    for (const sel of selects) {
      const idx = String(sel.dataset.idx);
      const kind = sel.dataset.kind;
      if (!cambios[idx]) cambios[idx] = {};
      if (kind === "estado") {
        const nuevoEstado = valueFromLabel(sel.value);
        const actualEstado = estadoByIdx.get(idx) || "Pendiente";
        if (nuevoEstado !== actualEstado) cambios[idx].estado = nuevoEstado;
      } else if (kind === "tipo") {
        const nuevoTipo = sel.value || "Ambas";
        const actualTipo = tipoByIdx.get(idx) || "Ambas";
        if (nuevoTipo !== actualTipo) cambios[idx].tipo = nuevoTipo;
      }
    }

    // Guardar por idx (una llamada por persona que cambió)
    const idxs = Object.keys(cambios);
    for (const idx of idxs) {
      const ch = cambios[idx];
      if (!ch.estado && !ch.tipo) continue; // nada cambió
      const url = `${apiUrl}?accion=actualizar_detalle&codigo=${encodeURIComponent(CURRENT.codigo)}&idx=${encodeURIComponent(idx)}${ch.estado ? `&estado=${encodeURIComponent(ch.estado)}` : ''}${ch.tipo ? `&tipo=${encodeURIComponent(ch.tipo)}` : ''}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Error HTTP ${res.status}`);
      const data = await res.json();
      if (!data.success) throw new Error(data.message || "No se pudo actualizar");
    }

    // Guardar comentario si cambió
    const nuevoComentario = (txtComentario.value || "").trim();
    if ((CURRENT.comentario || "") !== nuevoComentario) {
      const urlC = `${apiUrl}?accion=actualizar_comentario&codigo=${encodeURIComponent(CURRENT.codigo)}&comentario=${encodeURIComponent(nuevoComentario)}`;
      const resC = await fetch(urlC);
      if (!resC.ok) throw new Error(`Error HTTP ${resC.status}`);
      const dataC = await resC.json();
      if (!dataC.success) throw new Error(dataC.message || "No se pudo guardar el comentario");
    }

    await cargarInvitado(CURRENT.codigo);
    renderEncabezado();
    renderDetalles();
    alert("Actualizado.");
  } catch (err) {
    console.error(err);
    alert(err.message || "No se pudo guardar.");
  } finally {
    setLoading(btnGuardar, false);
  }
});

btnReiniciarTodos.addEventListener("click", async ()=>{
  setLoading(btnReiniciarTodos, true, "Reiniciando...");
  try {
    const url = `${apiUrl}?accion=reiniciar_todos&codigo=${encodeURIComponent(CURRENT.codigo)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Error HTTP ${res.status}`);
    const data = await res.json();
    if (!data.success) throw new Error(data.message || "No se pudo reiniciar");
    await cargarInvitado(CURRENT.codigo);
    renderEncabezado();
    renderDetalles();
  } catch (err) {
    console.error(err);
    alert(err.message || "No se pudo reiniciar.");
  } finally {
    setLoading(btnReiniciarTodos, false);
  }
});

btnSalir.addEventListener("click", resetFlow);
</script>
</body>
</html>

