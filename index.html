<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Confirmar Asistencia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .container { display: flex; min-height: 100vh; }
    .imagen {
      flex: 1;
      background-image: url('j%26M-54%20(1).jpg');
      background-size: cover;
      background-position: center;
    }
    .contenido {
      flex: 1; padding: 60px; display: flex; flex-direction: column;
      justify-content: center; text-align: center; background-color: #f7f7f7;
    }
    h1 { margin-bottom: 10px; }
    p { margin: 5px 0 20px; }
    input, button, select {
      padding: 12px; font-size: 16px; margin: 10px auto; border-radius: 20px;
      border: 1px solid #ccc; width: 70%; max-width: 520px; display: block;
    }
    #step2 #encabezado p { margin: 8px 0; }
    .muted { color:#666; font-weight: normal; }
    .error { color: #b00020; font-weight: normal; }
    button { cursor: pointer; background-color: #333; color: white; border: none; }
    button:hover { background-color: #555; }
    .grid { width: 90%; max-width: 820px; margin: 0 auto; text-align: left; }
    .grid .row { display: grid; grid-template-columns: 2.2fr 1.1fr 1fr; gap: 10px; align-items: center; margin: 8px 0; }
    .controls { display:flex; gap:8px; justify-content:center; margin-top: 8px; }
    .nameInput { width: 100%; border-radius: 10px; }
    @media (max-width: 900px) {
      .container { flex-direction: column; }
      .imagen { min-height: 40vh; }
      .contenido { padding: 32px; }
      input, button, select { width: 100%; }
      .grid .row { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="imagen" aria-hidden="true"></div>

  <div class="contenido">
    <h1>CONFIRMAR ASISTENCIA</h1>

    <!-- Paso 1 -->
    <div id="step1">
      <p>Por favor ingresa tu código de invitado.</p>
      <input type="text" id="codigo" placeholder="Ingresa tu código de invitado" autocomplete="one-time-code" />
      <button id="btnContinuar">Continuar</button>
      <div id="msg1" class="error"></div>
    </div>

    <!-- Paso 2 -->
    <div id="step2" style="display:none;">
      <div id="encabezado"></div>

      <div id="detalles" class="grid"></div>

      <div class="controls">
        <button id="btnConfirmarTodos">Confirmar todos</button>
        <button id="btnReiniciarTodos">Reiniciar a pendiente</button>
      </div>

      <div id="foot" class="muted" style="margin-top:16px;">
        Gracias por acompañarnos en este momento tan importante de nuestras vidas.
      </div>
    </div>
  </div>
</div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbwsBt2VLDgYQt_o48jflUBQfHTwHKCY4t_3coQWHtZAAnUKwQoxDZIgIT6T-vv-Ozoubg/exec";

const $ = (s)=>document.querySelector(s);
const step1 = $("#step1");
const step2 = $("#step2");
const inputCodigo = $("#codigo");
const btnContinuar = $("#btnContinuar");
const msg1 = $("#msg1");
const encabezado = $("#encabezado");
const detallesEl = $("#detalles");
const btnConfirmarTodos = $("#btnConfirmarTodos");
const btnReiniciarTodos = $("#btnReiniciarTodos");

const MENSAJE = `Estamos muy felices de poder compartir contigo este momento tan especial.
Tu presencia hará aún más inolvidable nuestra celebración.`;

let CURRENT = { codigo: "", nombre: "", pases: 0, estado: "", detalles: [] };

function setLoading(btn, loading=true, text="Cargando..."){
  if (!btn) return;
  if (loading) { btn.dataset.prevText = btn.textContent; btn.textContent = text; btn.disabled = true; }
  else { btn.textContent = btn.dataset.prevText || btn.textContent; btn.disabled = false; }
}

function renderEncabezado() {
  const { nombre, pases, estado } = CURRENT;
  encabezado.innerHTML = `
    <p><strong>Nombre:</strong> ${nombre || "(Sin nombre)"}</p>
    <p class="muted" style="max-width:70%;margin:0 auto 16px;">${MENSAJE}</p>
    <p><strong>No. de pases:</strong> ${pases}</p>
    <p><strong>Estado general:</strong> ${estado || "Pendiente"}</p>
  `;
}

function renderDetalles() {
  detallesEl.innerHTML = "";
  const head = document.createElement("div");
  head.className = "row";
  head.innerHTML = `<strong>Nombre</strong><strong>Estado</strong><strong>Acción</strong>`;
  detallesEl.appendChild(head);

  CURRENT.detalles.forEach(d => {
    const row = document.createElement("div");
    row.className = "row";

    // Nombre editable
    const col1 = document.createElement("div");
    const nameInput = document.createElement("input");
    nameInput.className = "nameInput";
    nameInput.value = d.nombre || ("Invitado " + d.idx);
    col1.appendChild(nameInput);

    // Estado
    const col2 = document.createElement("div");
    const sel = document.createElement("select");
    ["Pendiente","Confirmado","Rechazado"].forEach(s=>{
      const opt = document.createElement("option");
      opt.value = s; opt.textContent = s;
      if ((d.estado || "Pendiente") === s) opt.selected = true;
      sel.appendChild(opt);
    });
    col2.appendChild(sel);

    // Acción
    const col3 = document.createElement("div");
    const btn = document.createElement("button");
    btn.textContent = "Actualizar";
    btn.addEventListener("click", async ()=>{
      await actualizarDetalle(d.idx, sel.value, nameInput.value.trim());
    });
    col3.appendChild(btn);

    row.appendChild(col1); row.appendChild(col2); row.appendChild(col3);
    detallesEl.appendChild(row);
  });
}

async function cargarInvitado(codigo) {
  const url = `${apiUrl}?codigo=${encodeURIComponent(codigo)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();
  if (data.error) throw new Error(data.error);

  CURRENT = {
    codigo,
    nombre: data.nombre,
    pases: data.pases,
    estado: data.estado || "Pendiente",
    detalles: data.detalles || [] // [{idx,nombre,estado}]
  };
}

async function actualizarDetalle(idx, estado, nombre) {
  const url = `${apiUrl}?accion=actualizar_detalle&codigo=${encodeURIComponent(CURRENT.codigo)}&idx=${idx}&estado=${encodeURIComponent(estado)}&nombre=${encodeURIComponent(nombre || "")}`;
  const res = await fetch(url);
  if (!res.ok) { alert(`Error HTTP ${res.status}`); return; }
  const data = await res.json();
  if (!data.success) { alert(data.message || "No se pudo actualizar"); return; }
  await cargarInvitado(CURRENT.codigo);
  renderEncabezado();
  renderDetalles();
}

btnContinuar.addEventListener("click", async ()=>{
  const codigo = inputCodigo.value.trim();
  if (!codigo) { msg1.textContent = "Por favor ingresa tu código."; inputCodigo.focus(); return; }

  msg1.textContent = "";
  setLoading(btnContinuar, true, "Buscando...");
  try {
    await cargarInvitado(codigo);
    step1.style.display = "none";
    step2.style.display = "block";
    renderEncabezado();
    renderDetalles();
  } catch (err) {
    console.error(err);
    msg1.textContent = err.message || "No se pudo encontrar el invitado.";
  } finally {
    setLoading(btnContinuar, false);
  }
});

inputCodigo.addEventListener("keydown", (e)=>{ if (e.key === "Enter") btnContinuar.click(); });

btnConfirmarTodos.addEventListener("click", async ()=>{
  const url = `${apiUrl}?accion=confirmar_todos&codigo=${encodeURIComponent(CURRENT.codigo)}`;
  const res = await fetch(url);
  if (!res.ok) { alert(`Error HTTP ${res.status}`); return; }
  const data = await res.json();
  if (!data.success) { alert(data.message || "No se pudo confirmar todos"); return; }
  await cargarInvitado(CURRENT.codigo);
  renderEncabezado();
  renderDetalles();
});

btnReiniciarTodos.addEventListener("click", async ()=>{
  const url = `${apiUrl}?accion=reiniciar_todos&codigo=${encodeURIComponent(CURRENT.codigo)}`;
  const res = await fetch(url);
  if (!res.ok) { alert(`Error HTTP ${res.status}`); return; }
  const data = await res.json();
  if (!data.success) { alert(data.message || "No se pudo reiniciar"); return; }
  await cargarInvitado(CURRENT.codigo);
  renderEncabezado();
  renderDetalles();
});
</script>
</body>
</html>

